version: '2'

services:

  mqtt5:
    image: eclipse-mosquitto
    ports:
      - "1883:1883" #default mqtt port
      - "9001:9001" #default mqtt port for websockets
    volumes:
      - ../src/docker/mqtt5/config:/mosquitto/config:rw
      - ../src/docker/mqtt5/data:/mosquitto/data:rw
      - ../src/docker/mqtt5/log:/mosquitto/log:rw
  
  timescale:
    image: timescale/timescaledb:latest-pg16
    environment:
      POSTGRES_USER: "${DBUSER}"
      POSTGRES_PASSWORD: "${PASSWORD}"
      POSTGRES_DB: "${DATABASE}"
    ports:
      - "5432:5432"
    volumes:
      - postgres-db-volume:/var/lib/postgresql/data
      - ../src/docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    restart: unless-stopped 

  consumer:
    build: 
      context: ../
      dockerfile: src/docker/consumer/consumer.Dockerfile
    depends_on:
      - "mqtt5"
    restart: unless-stopped
    
  weather:
    build: 
      context: ../
      dockerfile: src/docker/weather/weather.Dockerfile
    depends_on:
      - "mqtt5"
    restart: unless-stopped

  webscraper:
    build: 
      context: ../
      dockerfile: src/docker/webscraper/webscraper.Dockerfile
    depends_on:
      - "mqtt5"
    restart: unless-stopped


volumes:
  postgres-db-volume:
  config:
  data:
  log: